

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="https://sukicdn.com/wyx/i/2025/01/10/3lc6t.png">
  <link rel="icon" href="https://sukicdn.com/wyx/i/2025/01/10/3lc6t.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#FFB90F">
  <meta name="author" content="MarisaMagic">
  <meta name="keywords" content="">
  
    <meta name="description" content="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼›ä»…æœ‰äº’æ–¥é”çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°ï¼›std::condition_variable çš„åŸºæœ¬æ¦‚å¿µï¼›ä½¿ç”¨ std::condition_variable çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…ä¸­æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶ä¼˜åŒ–ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€ŒC++ å¤šçº¿ç¨‹ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åŠ std::condition_variable">
<meta property="og:url" content="https://marisamagic.github.io/2025/01/01/20250101/index.html">
<meta property="og:site_name" content="MarisaMagic&#39;s Blog">
<meta property="og:description" content="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼›ä»…æœ‰äº’æ–¥é”çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°ï¼›std::condition_variable çš„åŸºæœ¬æ¦‚å¿µï¼›ä½¿ç”¨ std::condition_variable çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„å®ç°ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…ä¸­æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶ä¼˜åŒ–ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sukicdn.com/wyx/i/2025/01/01/7hnsg.png">
<meta property="article:published_time" content="2025-01-01T05:15:40.584Z">
<meta property="article:modified_time" content="2025-01-01T13:33:15.157Z">
<meta property="article:author" content="MarisaMagic">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="å¤šçº¿ç¨‹">
<meta property="article:tag" content="std::thread">
<meta property="article:tag" content="std::mutex">
<meta property="article:tag" content="std::condition_variable">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sukicdn.com/wyx/i/2025/01/01/7hnsg.png">
  
  
  
  <title>ã€ŒC++ å¤šçº¿ç¨‹ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åŠ std::condition_variable - MarisaMagic&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/scrollAnimation.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"marisamagic.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#F9B002","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"https://sukicdn.com/wyx/i/2025/01/10/dlz.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 90vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>MarisaMagic | é›¾é›¨é­”æ³•åº—</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>å‹é“¾</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://sukicdn.com/wyx/i/2025/01/01/7hnsg.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€ŒC++ å¤šçº¿ç¨‹ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åŠ std::condition_variable"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        MarisaMagic
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-01 13:15" pubdate>
          2025å¹´1æœˆ1æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.3k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          53 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ã€ŒC++ å¤šçº¿ç¨‹ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åŠ std::condition_variable</h1>
            
            
              <div class="markdown-body">
                
                <p>æ–‡ç« å¤§å›¾æ¥æºï¼š<a target="_blank" rel="noopener" href="https://www.pixiv.net/artworks/125244936">pixiv_id=125244936</a></p>
<h2 id="å…ƒæ—¦å¿«ä¹ï¼ğŸ‰ğŸ¤—">å…ƒæ—¦å¿«ä¹ï¼ğŸ‰ğŸ¤—</h2>
<h2 id="1-é—®é¢˜èƒŒæ™¯">1 é—®é¢˜èƒŒæ™¯</h2>
<h3 id="1-1-ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜">1.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</h3>
<p><a id='111'></a></p>
<h4 id="1-1-1-å®šä¹‰">1.1.1 å®šä¹‰</h4>
<p><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</strong>ï¼ˆProducer - Consumer Problemï¼‰æ˜¯ä¸€ä¸ªç»å…¸çš„å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜æè¿°äº†åœ¨ä¸€ä¸ªå…±äº«ç¼“å†²åŒºç¯å¢ƒä¸‹ï¼Œä¸¤ç±»çº¿ç¨‹ï¼ˆåˆ†åˆ«ä¸º <strong>ç”Ÿäº§è€…</strong> å’Œ <strong>æ¶ˆè´¹è€…</strong>ï¼‰ä¹‹é—´çš„åä½œå…³ç³»ã€‚</p>
<p><strong>ç”Ÿäº§è€…</strong>ï¼šè´Ÿè´£ç”Ÿæˆæ•°æ®ï¼Œå¹¶å°†æ•°æ®æ”¾å…¥å…±äº«ç¼“å†²åŒºï¼›</p>
<p><strong>æ¶ˆè´¹è€…</strong>ï¼šä»å…±äº«ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®ï¼Œå¹¶è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç”œå“åº—ä¸­ï¼Œç”œç‚¹å¸ˆï¼ˆç”Ÿäº§è€…ï¼‰åˆ¶ä½œç”œç‚¹å¹¶ä¸”å°†å…¶æ”¾åœ¨å±•ç¤ºæ¶ï¼ˆç¼“å†²åŒºï¼‰ï¼Œé¡¾å®¢ï¼ˆæ¶ˆè´¹è€…ï¼‰ä»å±•ç¤ºæ¶ï¼ˆç¼“å†²åŒºï¼‰ä¸Šæ‹¿èµ°ç”œç‚¹å¹¶è´­ä¹°æ¶ˆè´¹ã€‚</p>
<h4 id="1-1-2-é—®é¢˜çº¦æŸ">1.1.2 é—®é¢˜çº¦æŸ</h4>
<ol>
<li>
<p>å…±äº«ç¼“å†²åŒºé€šå¸¸æœ‰ä¸€ä¸ªå›ºå®šçš„å¤§å°ï¼›</p>
</li>
<li>
<p>åŒæ­¥é—®é¢˜ï¼š</p>
<p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é€Ÿåº¦å¯èƒ½ä¸åŒã€‚ç”Ÿäº§è€…å¯èƒ½ç”Ÿäº§æ•°æ®çš„é€Ÿåº¦æ¯”æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®å¿«ï¼Œå¯¼è‡´ç¼“å†²åŒºè¢«å¡«æ»¡ï¼Œæ­¤æ—¶è¦ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€äº›æ•°æ®ï¼›åä¹‹ï¼Œæ¶ˆè´¹è€…å¯èƒ½æ¶ˆè´¹æ•°æ®çš„é€Ÿåº¦æ›´å¿«ï¼Œç¼“å†²åŒºå¯èƒ½å‡ºç°ç©ºçš„æƒ…å†µï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…è¦ç­‰å¾…ç”Ÿäº§è€…æ”¾å…¥æ•°æ®ã€‚</p>
<ul>
<li>
<p>å½“ç¼“å†²åŒºå·²æ»¡æ—¶ï¼Œ<strong>ç”Ÿäº§è€…</strong> éœ€è¦ç­‰å¾… <strong>æ¶ˆè´¹è€…</strong> å–å‡ºæ•°æ®åï¼Œæ‰èƒ½ç»§ç»­æ”¾å…¥æ•°æ®ï¼›</p>
</li>
<li>
<p>å½“ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œ<strong>æ¶ˆè´¹è€…</strong> éœ€è¦ç­‰å¾… <strong>ç”Ÿäº§è€…</strong> æ”¾å…¥æ•°æ®åï¼Œæ‰èƒ½ç»§ç»­å–å‡ºæ•°æ®ï¼›</p>
</li>
</ul>
</li>
<li>
<p>äº’æ–¥é—®é¢˜ï¼š</p>
<p>å…±äº«ç¼“å†²åŒºåŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚ä¸¤ç±»çº¿ç¨‹å¯¹å…±äº«ç¼“å†²åŒºéœ€è¦äº’æ–¥è®¿é—®ã€‚å¦‚æœä¸è¿›è¡Œäº’æ–¥è®¿é—®ï¼Œä¼šé€ æˆæ•°æ®ç«äº‰ã€æ•°æ®ä¸ä¸€è‡´ç­‰é—®é¢˜ã€‚</p>
</li>
</ol>
<h3 id="1-2-ä»…ç”¨äº’æ–¥é”å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…">1.2 ä»…ç”¨äº’æ–¥é”å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h3>
<h4 id="1-2-1-å®ç°æ€è·¯å’Œä»£ç ">1.2.1 å®ç°æ€è·¯å’Œä»£ç </h4>
<p>å¯¹äºä¸Šé¢ <a href="#111">1.1.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ å®šä¹‰</a> çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ <strong>äº’æ–¥é”</strong> æ¥ç¡®ä¿ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯¹å…±äº«ç¼“å†²åŒºçš„äº’æ–¥è®¿é—®ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ€ä¹ˆå¤„ç†ä¸¤ç±»çº¿ç¨‹çš„åŒæ­¥é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å…ˆè€ƒè™‘ä¸€ç§æ¯”è¾ƒä½æ•ˆçš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>å¦‚æœ <strong>ç”Ÿäº§è€…</strong> çº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå‘ç°ç¼“å†²åŒºå·²æ»¡ï¼Œé‚£ä¹ˆå°±å…ˆé‡Šæ”¾é”ï¼Œä¼‘æ¯ä¸€æ®µæ—¶é—´ã€‚åœ¨ä¼‘æ¯çš„æ—¶é—´æ®µå†…ï¼Œ<strong>æ¶ˆè´¹è€…</strong> çº¿ç¨‹æœ‰æœºä¼šè·å¾—é”å¹¶æ¶ˆè´¹æ•°æ®ï¼›</p>
</li>
<li>
<p>å¦‚æœ <strong>æ¶ˆè´¹è€…</strong> çº¿ç¨‹è·å¾—é”ä¹‹åï¼Œå‘ç°ç¼“å†²åŒºä¸ºç©ºï¼Œé‚£ä¹ˆå°±å…ˆé‡Šæ”¾é”ï¼Œä¼‘æ¯ä¸€æ®µæ—¶é—´ã€‚åœ¨ä¼‘æ¯çš„æ—¶é—´æ®µå†…ï¼Œ<strong>ç”Ÿäº§è€…</strong> çº¿ç¨‹æœ‰æœºä¼šè·å¾—é”å¹¶ç”Ÿäº§æ•°æ®ã€‚</p>
</li>
</ul>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç®€æ˜“çš„ ç”Ÿäº§è€…-æ¶ˆè´¹è€… ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx;         <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::queue&lt;<span class="hljs-type">int</span>&gt; buffer; <span class="hljs-comment">// å…±äº«ç¼“å†²åŒº</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> buffer_size = <span class="hljs-number">10</span>; <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°é™åˆ¶</span><br><br><span class="hljs-comment">// ç”Ÿäº§è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> data_num)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= data_num; i ++ )&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-keyword">if</span>(buffer.<span class="hljs-built_in">size</span>() &lt; buffer_size)&#123; <span class="hljs-comment">// å¯ä»¥æ”¾å…¥æ•°æ®</span><br>            buffer.<span class="hljs-built_in">push</span>(i);<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Produced: &quot;</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">// ç¼“å†²åŒºå·²æ»¡</span><br>            lck.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// å…ˆè§£é”</span><br>            <span class="hljs-comment">// ä¼‘æ¯ä¸€æ®µæ—¶é—´å†å°è¯•</span><br>            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>)); <br>            i -- ; <span class="hljs-comment">// å›é€€</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-keyword">if</span>(!buffer.<span class="hljs-built_in">empty</span>())&#123; <span class="hljs-comment">// å¯ä»¥æ¶ˆè´¹æ•°æ®</span><br>            <span class="hljs-type">int</span> data = buffer.<span class="hljs-built_in">front</span>();<br>            buffer.<span class="hljs-built_in">pop</span>();<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Consumed: &quot;</span> &lt;&lt; data &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>            lck.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// æå‰è§£é”</span><br>            <span class="hljs-comment">// æ¨¡æ‹Ÿä¸ cv æ— å…³çš„æ•°æ®æ“ä½œ</span><br>            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            lck.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// å…ˆè§£é”</span><br>            <span class="hljs-comment">// ä¼‘æ¯ä¸€æ®µæ—¶é—´å†å°è¯•</span><br>            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>)); <br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::thread <span class="hljs-title">producer_thread</span><span class="hljs-params">(producer, <span class="hljs-number">100</span>)</span></span>;<br>    <span class="hljs-function">std::thread <span class="hljs-title">consumer_thread</span><span class="hljs-params">(consumer)</span></span>;<br>    producer_thread.<span class="hljs-built_in">join</span>();<br>    consumer_thread.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯èƒ½çš„éƒ¨åˆ†è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://sukicdn.com/wyx/i/2025/01/01/12xf5o.png" srcset="https://sukicdn.com/wyx/i/2025/01/10/dlz.gif" lazyload alt=""></p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½¿ç”¨ <code>std::queue</code> æ¥æ¨¡æ‹Ÿå…±äº«ç¼“å†²åŒºï¼Œç¼“å†²åŒºçš„å¤§å°è®¾å®šä¸º <code>10</code>ã€‚</p>
<p>åœ¨ç”Ÿäº§è€…å‡½æ•°ä¸­ï¼Œè¿›è¡Œ <code>data_num</code> æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ç”Ÿäº§ä¸€ä¸ªæ•°æ®ã€‚ç”±äºéœ€è¦ä¸€äº›æå‰è§£é”ç„¶åä¼‘æ¯çš„æ“ä½œï¼Œå› æ­¤é‡‡ç”¨äº† <code>std::unique_lock</code> æ›´åŠ çµæ´»åœ°å¤„ç†åŠ é”ã€è§£é”ã€‚å¦‚æœç¼“å†²åŒºæœªæ»¡ï¼Œé‚£ä¹ˆå¯ä»¥æ”¾å…¥æ•°æ®ï¼›å¦åˆ™ï¼Œå…ˆè§£é”ï¼Œç„¶åä¼‘æ¯ä¸€æ®µæ—¶é—´ï¼Œä½¿å¾—æ¶ˆè´¹è€…çº¿ç¨‹æœ‰æœºä¼šè·å¾—é”ã€‚</p>
<p>åœ¨æ¶ˆè´¹è€…å‡½æ•°ä¸­ï¼Œæ¶ˆè´¹è€…ä¸æ–­æ¶ˆè´¹æ•°æ®ã€‚ä¹Ÿé‡‡ç”¨äº† <code>std::unique_lock</code> å¤„ç†åŠ é”ã€è§£é”ã€‚å¦‚æœç¼“å†²åŒºä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå¯ä»¥å–å‡ºæ•°æ®ï¼Œå–å‡ºæ•°æ®åï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€äº›å¤„ç†ç­‰æ“ä½œï¼Œå¹¶ä¸”è¿™äº›æ“ä½œä¸éœ€è¦äº’æ–¥é‡ç»´æŠ¤ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆæå‰è§£é”ï¼Œç„¶åå†è¿›è¡Œå¯¹æ•°æ®çš„ä¸€ç³»åˆ—æ“ä½œï¼›å¦åˆ™ï¼Œå…ˆè§£é”ï¼Œç„¶åä¼‘æ¯ä¸€æ®µæ—¶é—´ï¼Œä½¿å¾—ç”Ÿäº§è€…çº¿ç¨‹æœ‰æœºä¼šè·å¾—é”ã€‚</p>
<h4 id="1-2-2-å­˜åœ¨çš„é—®é¢˜">1.2.2 å­˜åœ¨çš„é—®é¢˜</h4>
<p>å¯ä»¥çœ‹å‡ºï¼Œâ€œä¼‘æ¯ä¸€æ®µæ—¶é—´â€ çš„åšæ³•æ˜¾ç„¶æ˜¯æ¯”è¾ƒä½æ•ˆçš„ï¼Œä¸»è¦é—®é¢˜åœ¨äºï¼š</p>
<ul>
<li>
<p><strong>å¿™ç­‰å¾…</strong>ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åœ¨æ— æ³•ç»§ç»­æ“ä½œæ—¶é€šè¿‡ä¼‘çœ æ¥ç­‰å¾…ç¼“å†²åŒºçŠ¶æ€æ”¹å˜ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šä¼‘çœ å¾ˆå¤šæ¬¡ï¼Œè¿™å°±å¯¼è‡´äº†èµ„æºçš„æµªè´¹ã€‚</p>
</li>
<li>
<p><strong>ç¼ºå°‘åŒæ­¥æœºåˆ¶</strong>ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… <strong>ä¸çŸ¥é“ä½•æ—¶</strong> å» <strong>ç­‰å¾…</strong> æˆ– <strong>ç»§ç»­å·¥ä½œ</strong>ã€‚ç¼“å†²åŒºä¸­æœ‰æ•°æ®äº†ï¼Œæ— æ³•åŠæ—¶é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹æ•°æ®ï¼›ç¼“å†²åŒºæœ‰ç©ºç¼ºäº†ï¼Œä¹Ÿæ— æ³•åŠæ—¶é€šçŸ¥ç”Ÿäº§è€…å¯ä»¥æ”¾å…¥æ•°æ®ã€‚</p>
</li>
</ul>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒC++11 å¼•å…¥äº† <strong>æ¡ä»¶å˜é‡</strong> std::condition_variableã€‚</p>
<p><a id='2'></a></p>
<h2 id="2-std-condition-variable">2 std::condition_variable</h2>
<h3 id="2-1-åŸºæœ¬æ¦‚å¿µ">2.1 åŸºæœ¬æ¦‚å¿µ</h3>
<p><code>std::condition_variable</code> æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œåœ¨å¤´æ–‡ä»¶ <code>&lt;condition_variable&gt;</code> ä¸­ï¼Œä¸»è¦ç”¨äº <strong>çº¿ç¨‹é—´çš„åŒæ­¥</strong>ã€‚<code>std::condition_variable</code> åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å®ç°çº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…å’Œé€šçŸ¥æœºåˆ¶æœ‰ç€é‡è¦ä½œç”¨ã€‚</p>
<h3 id="2-2-æˆå‘˜å‡½æ•°å’ŒåŸºæœ¬ç”¨æ³•">2.2 æˆå‘˜å‡½æ•°å’ŒåŸºæœ¬ç”¨æ³•</h3>
<p><a id='221'></a></p>
<h4 id="2-2-1-wait">2.2.1 wait()</h4>
<p><code>std::condition_variable::wait()</code> å‡½æ•°æ˜¯ <code>std::condition_variable</code> ä¸­çš„ä¸€ä¸ªå…³é”®æˆå‘˜å‡½æ•°ï¼Œä¸»è¦ç”¨äºè®©çº¿ç¨‹ <strong>ç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹</strong>ï¼Œé€šå¸¸é…åˆäº’æ–¥é‡ï¼ˆmutexï¼‰è¿›å’Œ <code>std::unique_lock</code> ä½¿ç”¨ï¼Œä»¥å®ç°çº¿ç¨‹çš„åŒæ­¥ã€‚</p>
<p>å…¶åŸºæœ¬çš„å‡½æ•°åŸå‹ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">class</span> Predicate &gt;</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait</span><span class="hljs-params">( std::unique_lock&lt;std::mutex&gt;&amp; lock, Predicate pred )</span></span>;<br></code></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>lock</code> æ˜¯äº’æ–¥é”ï¼›<code>pred</code> æ˜¯ä¸€ä¸ª <code>Predicate</code> ç±»å‹ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ª <strong>å¯è°ƒç”¨å¯¹è±¡</strong>ï¼ˆä¾‹å¦‚å‡½æ•°ã€lambda è¡¨ç¤ºã€å‡½æ•°æŒ‡é’ˆç­‰ï¼‰ã€‚</p>
<p>åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// æ¡ä»¶å˜é‡ å’Œ äº’æ–¥é‡</span><br>std::condition_variable cv;<br>std::mutex mtx;<br><br><span class="hljs-comment">// çº¿ç¨‹å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait_foo</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>    cv.<span class="hljs-built_in">wait</span>(lck, <span class="hljs-built_in">check</span>()); <span class="hljs-comment">// check() ä¸ºåˆ¤æ–­æ¡ä»¶æ˜¯å¦æˆç«‹çš„å‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>å½“ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ä¹‹åï¼Œè°ƒç”¨ <code>wait()</code> å‡½æ•°æ—¶ï¼š</p>
<ul>
<li>
<p>å¦‚æœ <code>check()</code> å‡½æ•°åˆ¤æ–­æ¡ä»¶ä¸º <code>true</code>ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼›</p>
</li>
<li>
<p>å¦‚æœ <code>check()</code> å‡½æ•°åˆ¤æ–­æ¡ä»¶ä¸º <code>false</code>ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šé˜»å¡åœ¨ <code>cv.wait(lck, check());</code> è¿™ä¸€è¡Œï¼Œè¿›å…¥ç­‰å¾…ï¼ŒåŒæ—¶ <strong>çº¿ç¨‹ä¼šè‡ªåŠ¨åœ°æš‚æ—¶é‡Šæ”¾é”</strong>ã€‚</p>
<p>çº¿ç¨‹è¿›å…¥é˜»å¡ï¼ˆç­‰å¾…ï¼‰çŠ¶æ€ï¼Œç›´åˆ°åˆ¤æ–­æ¡ä»¶å˜ä¸º <code>true</code> æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œå¹¶é‡æ–°è·å¾—é”ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p>
<p>è€Œæ¡ä»¶æˆç«‹åï¼Œçº¿ç¨‹çš„å”¤é†’éœ€è¦é…åˆå¦ä¸€ä¸ª <code>std::condition_variable</code> ä¸­çš„å‡½æ•°â€”â€” <code>std::condition_variable::notify_one()</code>ï¼ˆæˆ–è€… <code>std::condition_variable::notify_all()</code>ï¼‰ã€‚</p>
</li>
</ul>
<p>å¦‚æœ <code>wait()</code> å‡½æ•°ä¸åŠ  <strong>å¯è°ƒç”¨å¯¹è±¡</strong> è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆ <code>std::condition_variable::wait()</code> <strong>é»˜è®¤æ¡ä»¶ä¸º <code>false</code></strong>ï¼Œçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// çº¿ç¨‹å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait_foo</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>    cv.<span class="hljs-built_in">wait</span>(lck); <span class="hljs-comment">// ä¸åŠ å¯è°ƒç”¨å¯¹è±¡å‚æ•°ï¼Œé»˜è®¤ä¸º falseï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong> åœ¨ä½¿ç”¨ <code>wait()</code> å‡½æ•°æ—¶ï¼Œåªèƒ½æ­é… <code>std::unique_lock</code> äº’æ–¥é”ä½¿ç”¨ï¼Œä¸èƒ½ä½¿ç”¨ <code>std::lock_guard</code>ã€‚<code>std::condition_variable::wait()</code> éœ€è¦åœ¨ç­‰å¾…æœŸé—´è‡ªåŠ¨é‡Šæ”¾äº’æ–¥é‡ï¼Œç„¶ååœ¨è¢«å”¤é†’åé‡æ–°è·å–äº’æ–¥é‡ã€‚ä½†æ˜¯ <code>std::lock_guard</code> æ²¡æœ‰æä¾›è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<h4 id="2-2-2-notify-one">2.2.2 notify_one()</h4>
<p><code>std::condition_variable::notify_one()</code> ä¸»è¦ç”¨äºå½“æŸä¸ªæ¡ä»¶æˆç«‹ï¼Œé€šçŸ¥ <strong>ä¸€ä¸ª</strong> å¤„äºé˜»å¡çŠ¶æ€ä¸‹ï¼ˆç­‰å¾…è¯¥æ¡ä»¶æˆç«‹ï¼‰çš„çº¿ç¨‹ï¼Œè¿›è€Œå”¤é†’è¿™ä¸ªçº¿ç¨‹ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx; <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::condition_variable cv; <span class="hljs-comment">// æ¡ä»¶å˜é‡</span><br><span class="hljs-type">bool</span> flag; <span class="hljs-comment">// åˆ¤æ–­çš„æ¡ä»¶</span><br><br><span class="hljs-comment">// ç­‰å¾…æ¡ä»¶çº¿ç¨‹å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">wait_foo</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;wait_foo(): wating...&quot;</span> &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    cv.<span class="hljs-built_in">wait</span>(lck, []&#123; <span class="hljs-keyword">return</span> flag; &#125;);<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;wait_foo(): waiting ends, flag = &quot;</span> &lt;&lt; flag &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// é€šçŸ¥å”¤é†’çº¿ç¨‹å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notify_foo</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">// ç¬¬ä¸€æ¬¡å°è¯•å”¤é†’ã€‚ä½†æ˜¯ä¸æ»¡è¶³æ¡ä»¶ï¼Œå”¤é†’å¤±è´¥</span><br>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">2</span>)); <br>    &#123;<br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;notify_foo(): notifying...&quot;</span> &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>    cv.<span class="hljs-built_in">notify_one</span>(); <span class="hljs-comment">// ä½œç”¨åŸŸç»“æŸè§£é”åå†å”¤é†’æ›´å¥½</span><br><br>    <span class="hljs-comment">// ç¬¬äºŒæ¬¡å°è¯•å”¤é†’ã€‚æ»¡è¶³æ¡ä»¶ï¼ŒæˆåŠŸå”¤é†’ã€‚</span><br>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">2</span>)); <br>    &#123;<br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        flag = <span class="hljs-literal">true</span>;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;notify_foo(): notifying again...&quot;</span> &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>    cv.<span class="hljs-built_in">notify_one</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::thread <span class="hljs-title">wait_t</span><span class="hljs-params">(wait_foo)</span></span>;<br>    <span class="hljs-function">std::thread <span class="hljs-title">notify_t</span><span class="hljs-params">(notify_foo)</span></span>;<br>    <span class="hljs-type">wait_t</span>.<span class="hljs-built_in">join</span>();<br>    <span class="hljs-type">notify_t</span>.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªç­‰å¾…æ¡ä»¶çš„çº¿ç¨‹å‡½æ•° <code>wait_foo()</code> å’Œä¸€ä¸ªé€šçŸ¥å”¤é†’çš„çº¿ç¨‹å‡½æ•° <code>notify_foo()</code>ã€‚æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªçº¿ç¨‹ <code>wait_t</code> ç­‰å¾…æ¡ä»¶æˆç«‹ï¼Œä¸€ä¸ªçº¿ç¨‹ <code>notify_t</code> ç”¨äºå”¤é†’è¿™ä¸ªç­‰å¾…æ¡ä»¶æˆç«‹çš„çº¿ç¨‹ã€‚</p>
<p>åœ¨ <code>wait_foo()</code> ä¸­ï¼Œå…ˆå°è¯•è·å¾—é”ï¼Œè·å¾—é”ä¹‹åï¼Œåˆ¤æ–­æ¡ä»¶ <code>flag</code> æ˜¯å¦ä¸º <code>true</code>ï¼Œæ˜¾ç„¶ä¸€å¼€å§‹ <code>flag</code> ä¸º <code>false</code>ï¼Œæ‰€ä»¥ä¸€å¼€å§‹ <code>wait_t</code> ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒåŒæ—¶æš‚æ—¶é‡Šæ”¾é”ã€‚</p>
<p><code>notify_foo()</code> ä¸­ï¼Œä¸€å¼€å§‹å…ˆå°è¯•å”¤é†’ï¼Œæ­¤æ—¶æ¡ä»¶ <code>flag</code> æ²¡æœ‰è¿›è¡Œæ”¹å˜ï¼Œæ‰€ä»¥è¿™æ¬¡å”¤é†’æ˜¯å¤±è´¥çš„ï¼›ç„¶åå°è¯•è¿›è¡Œç¬¬äºŒæ¬¡å”¤é†’ï¼Œè¿™æ¬¡ä¿®æ”¹æ¡ä»¶ <code>flag</code> ä¸º <code>true</code>ï¼Œä¹‹åé€šçŸ¥å”¤é†’é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ <code>wait_t</code>ã€‚</p>
<p>å¤„äºé˜»å¡æ€çš„çº¿ç¨‹ <code>wait_t</code> åœ¨çº¿ç¨‹ <code>notify_t</code> ç¬¬äºŒæ¬¡è°ƒç”¨ <code>std::condition_variable::notify_one()</code> å‡½æ•°åï¼ˆæ­¤æ—¶æ¡ä»¶è¢«ä¿®æ”¹ä¸º <code>true</code>ï¼‰ï¼ŒæˆåŠŸè¢«å”¤é†’ï¼Œé‡æ–°è·å¾—é”ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p>
<p>å¯èƒ½çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://sukicdn.com/wyx/i/2025/01/01/w2oa.png" srcset="https://sukicdn.com/wyx/i/2025/01/10/dlz.gif" lazyload alt=""></p>
<h4 id="2-2-3-notify-all">2.2.3 notify_all()</h4>
<p>ä¸ <code>std::condition_variable::notify_one()</code> ä¸åŒçš„æ˜¯ï¼Œ<code>std::condition_variable::notify_all()</code> å”¤é†’çš„æ˜¯ <strong>æ‰€æœ‰</strong> å¤„äºé˜»å¡çŠ¶æ€ä¸‹ï¼ˆç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹ï¼‰ã€‚</p>
<p>åœ¨çº¿ç¨‹è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œ<code>std::condition_variable::notify_all()</code> é€šå¸¸æ¯”è¾ƒé«˜æ•ˆã€‚</p>
<p>ä½†æ˜¯ï¼Œ<code>std::condition_variable::notify_all()</code> åœ¨æœ‰å¤šç§è¿›è¡Œåˆ¤æ–­æ¡ä»¶æ˜¯å¦æˆç«‹çš„çº¿ç¨‹æ—¶ï¼Œä¼šå‡ºç°éƒ¨åˆ†å”¤é†’æ²¡æœ‰ç”¨çš„æƒ…å†µï¼š</p>
<p>ä¾‹å¦‚ï¼Œåœ¨å¤šç”Ÿäº§è€… - å¤šæ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ä¸€ä¸ªç”Ÿäº§è€…è°ƒç”¨ <code>std::condition_variable::notify_all()</code> å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å”¤é†’å…¶ä»–ä¸€äº›å¤„äºé˜»å¡æ€çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™äº›å”¤é†’å¯èƒ½æš‚æ—¶æ˜¯æ²¡æœ‰ç”¨çš„ã€‚</p>
<p>ä¸è¿‡è¿™ç§å½±å“æ¯”è¾ƒå°ã€‚å½“ä¸€ç±»çº¿ç¨‹åªæœ‰ä¸€ä¸ªæ—¶ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ <code>notify_one()</code>ï¼ˆæ¯æ¬¡å”¤é†’ä¸€ä¸ªå¤„äºé˜»å¡æ€çš„çº¿ç¨‹ï¼‰è¿›è¡Œå”¤é†’ï¼›å½“ä¸€ç±»çº¿ç¨‹æœ‰å¾ˆå¤šä¸ªæ—¶ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ <code>notify_all()</code>ã€‚</p>
<h2 id="3-ä½¿ç”¨-condition-variable-å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…">3 ä½¿ç”¨ condition_variable å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h2>
<p><a id='31'></a></p>
<h3 id="3-1-å®ç°æ€è·¯å’Œä»£ç ">3.1 å®ç°æ€è·¯å’Œä»£ç </h3>
<p>åœ¨ <a href="#2">2 std::condition_variable</a> ä¸­ï¼Œå·²ç»ä»‹ç»äº† <code>std::condition_variable</code> çš„åŸºæœ¬ç”¨æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ¡ä»¶å˜é‡æ¥å®ç° <strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</strong> é—®é¢˜ä¸­çš„åŒæ­¥æœºåˆ¶ã€‚</p>
<p>åœ¨ç”Ÿäº§è€…å‡½æ•° <code>producer</code> ä¸­ï¼Œæ¯æ¬¡ç”Ÿäº§å¹¶å‘ç¼“å†²åŒºæ”¾å…¥æ•°æ®å‰ï¼Œéœ€è¦ç­‰å¾…æ¡ä»¶ <code>buffer.size() &lt; BUFFER_SIZE</code> æˆç«‹ã€‚æ¡ä»¶æˆç«‹æ—¶ï¼Œçº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚ç¼“å†²åŒºä¸­å·²ç»æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶ç”Ÿäº§è€…çº¿ç¨‹éœ€è¦å°è¯•å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹ã€‚</p>
<p>åœ¨æ¶ˆè´¹è€…å‡½æ•° <code>consumer</code> ä¸­ï¼Œæ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ªæ•°æ®ä¹‹å‰ï¼Œéœ€è¦ç­‰å¾…æ¡ä»¶ <code>!buffer.empty()</code> æˆç«‹ã€‚ æ¡ä»¶æˆç«‹åç»§ç»­æ‰§è¡Œã€‚æ­¤æ—¶ç¼“å†²åŒºå‡ºç°ç©ºä½ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹éœ€è¦å”¤é†’ç”Ÿäº§è€…çº¿ç¨‹ã€‚</p>
<p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx; <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::condition_variable cv; <span class="hljs-comment">// æ¡ä»¶å˜é‡</span><br>std::queue&lt;<span class="hljs-type">int</span>&gt; buffer; <span class="hljs-comment">// å…±äº«ç¼“å†²åŒº</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> BUFFER_SIZE = <span class="hljs-number">10</span>; <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°</span><br><br><span class="hljs-comment">// ç”Ÿäº§è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> data_num)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= data_num; i ++ )&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer æœ‰ç©ºé—´å¯æ”¾å…¥æ•°æ®</span><br>        cv.<span class="hljs-built_in">wait</span>(lck, [&amp;]()&#123; <span class="hljs-keyword">return</span> buffer.<span class="hljs-built_in">size</span>() &lt; BUFFER_SIZE; &#125;);<br>        buffer.<span class="hljs-built_in">push</span>(i);<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Produced: &quot;</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        cv.<span class="hljs-built_in">notify_one</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer ä¸­æœ‰æ•°æ®å¯æ¶ˆè´¹</span><br>        cv.<span class="hljs-built_in">wait</span>(lck, [&amp;]()&#123; <span class="hljs-keyword">return</span> !buffer.<span class="hljs-built_in">empty</span>(); &#125;);<br>        <span class="hljs-type">int</span> data = buffer.<span class="hljs-built_in">front</span>();<br>        buffer.<span class="hljs-built_in">pop</span>();<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Consumed: &quot;</span> &lt;&lt; data &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        lck.<span class="hljs-built_in">unlock</span>();     <span class="hljs-comment">// æå‰è§£é”</span><br>        cv.<span class="hljs-built_in">notify_one</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„ç”Ÿäº§è€…çº¿ç¨‹</span><br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä¸ cv æ— å…³çš„æ•°æ®æ“ä½œ</span><br>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::thread <span class="hljs-title">producer_thread</span><span class="hljs-params">(producer, <span class="hljs-number">100</span>)</span></span>;<br>    <span class="hljs-function">std::thread <span class="hljs-title">consumer_thread</span><span class="hljs-params">(consumer)</span></span>;<br>    producer_thread.<span class="hljs-built_in">join</span>();<br>    consumer_thread.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯èƒ½çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://sukicdn.com/wyx/i/2025/01/01/3tzo.png" srcset="https://sukicdn.com/wyx/i/2025/01/10/dlz.gif" lazyload alt=""></p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œæ‰€ä»¥æš‚æ—¶åªè¦ç”¨ <code>notify_one()</code> å°±å¥½äº†ã€‚</p>
<h3 id="3-2-å¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…é—®é¢˜">3.2 å¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…é—®é¢˜</h3>
<h4 id="3-2-1-å¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å®ç°">3.2.1 å¤šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å®ç°</h4>
<p>åœ¨ <a href="#31">3.1 condition_variable å®ç°æ¶ˆè´¹è€…-ç”Ÿäº§è€…ä»£ç </a> ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚</p>
<p>ä½†å®é™…åœºæ™¯ä¸­å¾€å¾€ä¼šæœ‰å¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä¾‹å¦‚ <a href="#111">1.1.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜å®šä¹‰</a> ä¸­çš„ç”œç‚¹å¸ˆ-é¡¾å®¢çš„ä¾‹å­ï¼Œä¸€ä¸ªåº—é“ºé‡Œå¯èƒ½æœ‰å¤šä¸ªç”œç‚¹å¸ˆåœ¨åˆ¶ä½œï¼Œä¼šæœ‰å¾ˆå¤šä¸ªé¡¾å®¢å…‰ä¸´è¿™ä¸ªç”œå“åº—ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <a href="#31">3.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®ç°ä»£ç </a> ä¸­çš„ä»£ç ï¼Œåˆ›å»ºå¤šä¸ªç”Ÿäº§è€…çº¿ç¨‹å’Œå¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx; <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::condition_variable cv; <span class="hljs-comment">// æ¡ä»¶å˜é‡</span><br>std::queue&lt;<span class="hljs-type">int</span>&gt; buffer; <span class="hljs-comment">// å…±äº«ç¼“å†²åŒº</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> BUFFER_SIZE = <span class="hljs-number">10</span>; <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> PRODUCER_NUM = <span class="hljs-number">2</span>; <span class="hljs-comment">// ç”Ÿäº§è€…ä¸ªæ•°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> CONSUMER_NUM = <span class="hljs-number">5</span>; <span class="hljs-comment">// æ¶ˆè´¹è€…ä¸ªæ•°</span><br><br><span class="hljs-comment">// ç”Ÿäº§è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> data_num)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= data_num; i ++ )&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer æœ‰ç©ºé—´å¯æ”¾å…¥æ•°æ®</span><br>        cv.<span class="hljs-built_in">wait</span>(lck, [&amp;]()&#123; <span class="hljs-keyword">return</span> buffer.<span class="hljs-built_in">size</span>() &lt; BUFFER_SIZE; &#125;);<br>        buffer.<span class="hljs-built_in">push</span>(i);<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;producer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; produced data: &quot;</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer ä¸­æœ‰æ•°æ®å¯æ¶ˆè´¹</span><br>        cv.<span class="hljs-built_in">wait</span>(lck, [&amp;]()&#123; <span class="hljs-keyword">return</span> !buffer.<span class="hljs-built_in">empty</span>(); &#125;);<br>        <span class="hljs-type">int</span> data = buffer.<span class="hljs-built_in">front</span>();<br>        buffer.<span class="hljs-built_in">pop</span>();<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;consumer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; consumed data: &quot;</span> &lt;&lt; data &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        lck.<span class="hljs-built_in">unlock</span>();     <span class="hljs-comment">// æå‰è§£é”</span><br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„ç”Ÿäº§è€…çº¿ç¨‹</span><br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä¸ cv æ— å…³çš„æ•°æ®æ“ä½œï¼Œæ”¾åœ¨è§£é”å’Œé€šçŸ¥ä¹‹å</span><br>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">producers</span><span class="hljs-params">(PRODUCER_NUM)</span></span>;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">consumers</span><span class="hljs-params">(CONSUMER_NUM)</span></span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; producers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        producers[i] = std::<span class="hljs-built_in">thread</span>(producer, i + <span class="hljs-number">1</span>, <span class="hljs-number">100</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; consumers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        consumers[i] = std::<span class="hljs-built_in">thread</span>(consumer, i + <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : producers) t.<span class="hljs-built_in">join</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : consumers) t.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªç”Ÿäº§è€…ä¸ªæ•°å’Œä¸€ä¸ªæ¶ˆè´¹è€…ä¸ªæ•°ï¼Œåœ¨çº¿ç¨‹æ¥å£å‡½æ•°ä¸­ä¼ é€’äº†çº¿ç¨‹ç¼–å·æ ‡è®°çš„å‚æ•° <code>id</code>ï¼ˆä¾¿äºè¡¨ç¤ºä¸åŒçš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰ã€‚</p>
<p>ç”±äºç°åœ¨æ˜¯å¤šä¸ªç”Ÿäº§è€…çº¿ç¨‹å’Œå¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå› æ­¤å°† <code>notify_one()</code> æ”¹ä¸ºäº† <code>notify_all()</code>ã€‚å…¶ä»–éƒ¨åˆ†ä»£ç å¤§è‡´ç›¸åŒã€‚</p>
<p>å¯èƒ½çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://sukicdn.com/wyx/i/2025/01/01/zh1i.png" srcset="https://sukicdn.com/wyx/i/2025/01/10/dlz.gif" lazyload alt=""></p>
<p>çœ‹ä¼¼è¿è¡Œèµ·æ¥å¥½åƒæ²¡æœ‰ä»€ä¹ˆæ¯›ç—…ï¼Œä½†å®é™…ä¸Šåœ¨ <strong>å¤šç”Ÿäº§è€…çº¿ç¨‹ã€å¤šæ¶ˆè´¹è€…çº¿ç¨‹</strong> æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç° <strong>è™šå‡å”¤é†’</strong> çš„é—®é¢˜ã€‚</p>
<h4 id="3-2-2-è™šå‡å”¤é†’é—®é¢˜">3.2.2 è™šå‡å”¤é†’é—®é¢˜</h4>
<p><strong>è™šå‡å”¤é†’</strong> æ˜¯æŒ‡çº¿ç¨‹ä»ç­‰å¾…æ¡ä»¶å˜é‡ <code>std::condition_variable::wait()</code> å‡½æ•°ä¸­å”¤é†’ï¼Œä½†å®é™…ä¸Šç­‰å¾…çš„æ¡ä»¶å¹¶æ²¡æœ‰çœŸæ­£æ»¡è¶³ã€‚é€šå¸¸ <strong>è™šå‡å”¤é†’</strong> çš„é—®é¢˜æ˜¯ç”±äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ <strong>ç³»ç»Ÿè°ƒåº¦ã€ä¿¡å·ä¼ è¾“</strong> ç­‰åŸå› å¯¼è‡´çš„ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç¼“å†²åŒºä¸ºç©ºï¼Œå½“ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹æ”¾å…¥ä¸€ä¸ªæ•°æ®åï¼ˆæ”¾å…¥åç¼“å†²åŒºå°±è¿™ä¸€ä¸ªæ•°æ®ï¼‰ï¼Œé€šçŸ¥å”¤é†’äº†ä¸€ä¸ªç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹çš„æ—¶å€™ï¼Œæœ‰å¦ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹äº†è¿™ä¸ªå”¯ä¸€çš„æ•°æ®ã€‚è¿™æ˜¯çº¿ç¨‹è°ƒåº¦çš„ä¸ç¡®å®šæ€§æ‰€å¯¼è‡´çš„ã€‚</p>
<p>æ­¤æ—¶ï¼Œè¿™ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹æ”¶åˆ°è¢«å”¤é†’çš„é€šçŸ¥ï¼Œè¡¨é¢ä¸Šæ¡ä»¶æˆç«‹äº†ï¼Œä½†æ˜¯å®é™…ä¸Š <code>buffer</code> è¿˜æ˜¯ä¸ºç©ºã€‚è¿™å°±å‡ºç°äº† <strong>è™šå‡å”¤é†’</strong>ã€‚</p>
<p>åœ¨ç°å®åœºæ™¯ä¸­ï¼Œæˆ‘æƒ³è¦ä¹°è‰è“è›‹ç³•ä½†æ˜¯ç”œç‚¹å¸ˆæ­£åœ¨åˆ¶ä½œä¸­ï¼Œç­‰å¾…äº†ä¸€ä¼šï¼Œç”œç‚¹å¸ˆé€šçŸ¥æˆ‘å±•ç¤ºæ¶ä¸Šæœ‰æ–°çš„è‰è“è›‹ç³•äº†ï¼Œæˆ‘æ­£å‡†å¤‡å»æ‹¿çš„æ—¶å€™å´è¢«å¦ä¸€ä¸ªäººç»™æŠ¢å…ˆäº†ã€‚è¿™æ­£æ˜¯å¤ªå€’éœ‰äº†ï¼ğŸ“ğŸ°</p>
<p>è™šå‡å”¤é†’è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æƒ…å†µï¼Œæ€»ä¹‹ç±»ä¼¼ä¸Šè¿°çš„æ¡ä»¶æ²¡æœ‰å®é™…æ»¡è¶³çš„æƒ…å†µéƒ½å±äºè™šå‡å”¤é†’ã€‚</p>
<p><a id='323'></a></p>
<h4 id="3-2-3-è™šå‡å”¤é†’çš„è§£å†³">3.2.3 è™šå‡å”¤é†’çš„è§£å†³</h4>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹è¢«å”¤é†’åï¼Œ<strong>å†æ¬¡æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶æˆç«‹</strong>ã€‚å†æ¬¡æ£€æŸ¥æ¡ä»¶å¦‚æœå‘ç°ä¸æˆç«‹ï¼Œé‚£ä¹ˆçº¿ç¨‹éœ€è¦åˆä¸€æ¬¡è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª <strong>å¾ªç¯æ£€æŸ¥</strong>ã€‚</p>
<p>åœ¨ <a href="#221">2.2.1 std::condition_variable::wait()</a> ä¸­ï¼Œå¦‚æœ <code>wait()</code> å‡½æ•°ä¸æ¥å— <strong>å¯è°ƒç”¨å¯¹è±¡</strong> çš„å‚æ•°ï¼Œå‡½æ•°é»˜è®¤æ¡ä»¶ä¸º <code>false</code>ï¼Œçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>åœ¨ç”Ÿäº§è€…çº¿ç¨‹å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ª <code>while</code> å¾ªç¯ï¼Œå¾ªç¯åˆ¤æ–­çš„æ¡ä»¶ä¸º <code>buffer.size() &gt;= BUFFER_SIZE</code>ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>cv.wait(lck)</code>ï¼Œä½¿å¾—ç”Ÿäº§è€…çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒåŒæ—¶æš‚æ—¶é‡Šæ”¾äº’æ–¥é”ã€‚</p>
<p>ç”Ÿäº§è€…çº¿ç¨‹å¡åœ¨ <code>cv.wait(lck);</code> è¿™ä¸€è¡Œï¼Œå¦‚æœæŸä¸ªæ¶ˆè´¹è€…çº¿ç¨‹å”¤é†’äº†ç”Ÿäº§è€…çº¿ç¨‹ï¼Œé‚£ä¹ˆä¼šå†æ¬¡è¿›å…¥ <code>while</code> å¾ªç¯è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚å¦‚æœæ­¤æ—¶ <code>buffer.size() &lt; BUFFER_SIZE</code>ï¼Œé‚£ä¹ˆä¼šé€€å‡ºå¾ªç¯ï¼Œç„¶åç”Ÿäº§è€…çº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹å»ï¼›å¦åˆ™ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šå†æ¬¡é™·å…¥é˜»å¡çŠ¶æ€ï¼ŒåŒæ—¶æš‚æ—¶é‡Šæ”¾äº’æ–¥é”ã€‚</p>
<p>è¿™æ ·å°±é€šè¿‡ <code>while</code> å¾ªç¯å®ç°äº†å†æ¬¡æ£€æŸ¥ä»¥åŠå¾ªç¯æ£€æŸ¥ã€‚ç±»ä¼¼çš„ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¸­ä¹Ÿå¯ä»¥å†™ä¸€ä¸ª <code>while</code> å¾ªç¯ï¼Œç¡®ä¿æ¶ˆè´¹è€…çº¿ç¨‹ä¸ä¼šè¢«è™šå‡å”¤é†’ã€‚</p>
<p>ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx; <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::condition_variable cv; <span class="hljs-comment">// æ¡ä»¶å˜é‡</span><br>std::queue&lt;<span class="hljs-type">int</span>&gt; buffer; <span class="hljs-comment">// å…±äº«ç¼“å†²åŒº</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> BUFFER_SIZE = <span class="hljs-number">10</span>; <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> PRODUCER_NUM = <span class="hljs-number">2</span>; <span class="hljs-comment">// ç”Ÿäº§è€…ä¸ªæ•°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> CONSUMER_NUM = <span class="hljs-number">5</span>; <span class="hljs-comment">// æ¶ˆè´¹è€…ä¸ªæ•°</span><br><br><span class="hljs-comment">// ç”Ÿäº§è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> data_num)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= data_num; i ++ )&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer æœ‰ç©ºé—´å¯æ”¾å…¥æ•°æ®ï¼ˆå¾ªç¯æ£€æŸ¥ï¼Œé˜²æ­¢è™šå‡å”¤é†’ï¼‰</span><br>        <span class="hljs-keyword">while</span>(buffer.<span class="hljs-built_in">size</span>() &gt;= BUFFER_SIZE)&#123;<br>            cv.<span class="hljs-built_in">wait</span>(lck); <span class="hljs-comment">// é»˜è®¤ falseï¼Œè§£é”å¹¶è¿›å…¥ç­‰å¾…</span><br>        &#125;<br>        buffer.<span class="hljs-built_in">push</span>(i);<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;producer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; produced data: &quot;</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer ä¸­æœ‰æ•°æ®å¯æ¶ˆè´¹ï¼ˆå¾ªç¯æ£€æŸ¥ï¼Œé˜²æ­¢è™šå‡å”¤é†’ï¼‰</span><br>        <span class="hljs-keyword">while</span>(buffer.<span class="hljs-built_in">empty</span>())&#123;<br>            cv.<span class="hljs-built_in">wait</span>(lck); <span class="hljs-comment">// é»˜è®¤ falseï¼Œè§£é”å¹¶è¿›å…¥ç­‰å¾…</span><br>        &#125;<br>        <span class="hljs-type">int</span> data = buffer.<span class="hljs-built_in">front</span>();<br>        buffer.<span class="hljs-built_in">pop</span>();<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;consumer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; consumed data: &quot;</span> &lt;&lt; data &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        lck.<span class="hljs-built_in">unlock</span>();     <span class="hljs-comment">// æå‰è§£é”</span><br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„ç”Ÿäº§è€…çº¿ç¨‹</span><br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä¸ cv æ— å…³çš„æ•°æ®æ“ä½œï¼Œæ”¾åœ¨è§£é”å’Œé€šçŸ¥ä¹‹å</span><br>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">producers</span><span class="hljs-params">(PRODUCER_NUM)</span></span>;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">consumers</span><span class="hljs-params">(CONSUMER_NUM)</span></span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; producers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        producers[i] = std::<span class="hljs-built_in">thread</span>(producer, i + <span class="hljs-number">1</span>, <span class="hljs-number">100</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; consumers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        consumers[i] = std::<span class="hljs-built_in">thread</span>(consumer, i + <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : producers) t.<span class="hljs-built_in">join</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : consumers) t.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="3-3-æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶ç¼–å†™">3.3 æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶ç¼–å†™</h3>
<p>åœ¨ <a href="#323">3.2.3 è™šå‡å”¤é†’çš„è§£å†³</a> ä¸­ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº† <strong>è™šå‡å”¤é†’</strong> é—®é¢˜ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ¶ˆè´¹è€…ä¸€ç›´éƒ½åœ¨æ¶ˆè´¹æ•°æ®ï¼Œæ²¡æœ‰åœæ­¢çš„æ—¶å€™ã€‚ç”±äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„ç¨‹åºåˆ°æœ€åä¹Ÿæ²¡æœ‰åœæ­¢ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•å†™ä¸€ä¸ªåˆç†çš„æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶å‘¢ï¼Ÿä¸€ä¸ªæ¯”è¾ƒæ„šè ¢çš„åŠæ³•å°±æ˜¯ï¼Œè®°å½•æ•°æ®çš„æ•°é‡ï¼Œè¾¾åˆ°ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®çš„æ•°é‡ä¸Šé™æ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°ä¸­é€€å‡ºå¾ªç¯ã€‚ä½†æ˜¯è¿™ç§å†™æ³•çš„å±€é™æ€§æ¯”è¾ƒé«˜ï¼Œå¦‚æœç”Ÿäº§è€…ç”Ÿäº§æ•°æ®çš„ä»£ç æœ‰ä¸€ç‚¹æ”¹åŠ¨å°±å¾—è·Ÿç€ä¸€èµ·ä¿®æ”¹ã€‚</p>
<p>æˆ‘ä»¬åŒæ ·å¯ä»¥å€ŸåŠ©æ¡ä»¶å˜é‡æ¥å®ç°ä¸€ä¸ªåˆç†çš„æ¶ˆè´¹è€…é€€å‡ºæœºåˆ¶ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªå®Œæˆç”Ÿäº§å·¥ä½œçš„ç”Ÿäº§è€…è®¡æ•° <code>produce_finished_count</code>ï¼Œè¿™ä¸ªè®¡æ•° <strong>éœ€è¦äº’æ–¥è®¿é—®å’Œä¿®æ”¹</strong>ï¼š</p>
<ul>
<li>
<p>åœ¨ç”Ÿäº§è€…çº¿ç¨‹å‡½æ•°ç”Ÿäº§æ•°æ®å¾ªç¯ç»“æŸä¹‹åï¼Œç”Ÿäº§è€…çº¿ç¨‹å†æ¬¡è·å¾—é”ï¼Œç„¶åä¿®æ”¹ <code>produce_finished_count</code>ï¼ˆ<code>produce_finished_count ++ </code>ï¼‰ã€‚å¦‚æœä¿®æ”¹ä¹‹åï¼Œ<code>produce_finished_count</code> è¾¾åˆ°äº†ç”Ÿäº§è€…çº¿ç¨‹çš„æ€»æ•°ï¼Œé‚£ä¹ˆéœ€è¦å°è¯•å”¤é†’é˜»å¡çŠ¶æ€ä¸­çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œé€šçŸ¥å®ƒä»¬ä¸ä¼šå†æœ‰æ–°çš„æ•°æ®äº†ï¼›</p>
</li>
<li>
<p>åœ¨æ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°ä¸­ï¼Œå¦‚æœ <code>buffer.empty() &amp;&amp; produce_finished_count &lt; PRODUCER_NUM</code>ï¼Œè¡¨æ˜ç¼“å†²åŒºä¸ºç©ºï¼Œä½†æ˜¯è¿˜ä¼šæœ‰æ–°çš„æ•°æ®ç”Ÿäº§ï¼Œå› æ­¤è¿™æ—¶æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ <code>!buffer.empty()</code> æˆç«‹æ—¶ï¼ˆæœ‰æ•°æ®äº†ï¼‰ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œç„¶åï¼ˆå¯èƒ½ï¼‰é€€å‡ºå¾ªç¯ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚ä½†æ˜¯ï¼Œå¯èƒ½ä¼šåœ¨ <code>produce_finished_count == PRODUCER_NUM</code> æˆç«‹çš„æ—¶å€™ï¼Œçº¿ç¨‹è¢«é€šçŸ¥å”¤é†’ç„¶åé€€å‡ºå¾ªç¯ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ˜¯è¿™ç§æƒ…å†µï¼Œå¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼ˆç¼“å†²åŒºä¸ºç©ºï¼Œä¸”ä¸ä¼šæœ‰æ–°çš„æ•°æ®å†ç”Ÿäº§ï¼‰ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°å°±ä» <code>while(true)</code> ä¸­ <code>break</code> é€€å‡ºã€‚</p>
<p>å½“ç„¶ï¼Œåœ¨ç”Ÿäº§è€…çº¿ç¨‹å‡½æ•°ä¸­ï¼Œå½“ <code>produce_finished_count == PRODUCER_NUM</code> æˆç«‹æ—¶å»å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹ä¹Ÿä¸ä¸€å®šè¡¨æ˜å°±æ˜¯å®Œå…¨æ²¡æ•°æ®äº†ï¼Œå¯èƒ½ç¼“å†²åŒºè¿˜æœ‰ä¸€äº›æ•°æ®ï¼Œåªä¸è¿‡ä¸ä¼šæœ‰æ–°æ•°æ®å†ç”Ÿäº§äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹åœ¨ä¹‹ååˆ¤æ–­ <code>buffer.empty() &amp;&amp; produce_finished_count == PRODUCER_NUM</code> æ˜¯å¦æˆç«‹æ—¶ï¼Œ<code>buffer</code> å¹¶ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡Œä¸‹å»å»æ¶ˆè´¹ç¼“å†²åŒºçš„æ•°æ®ã€‚</p>
</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„é€€å‡ºæœºåˆ¶å®ç°å¸¦å…¥ç°å®åœºæ™¯ä¸­ï¼šç”œç‚¹å¸ˆä»Šå¤©å·¥ä½œé‡è¾¾åˆ°ä¸Šé™äº†ï¼Œä¸ä¼šå†åˆ¶ä½œæ–°çš„è‰è“è›‹ç³•äº†ï¼Œæˆ‘æ­£åœ¨ç­‰å¾…æ–°çš„è‰è“è›‹ç³•ï¼Œä½†æ˜¯è½®åˆ°æˆ‘çš„æ—¶å€™ï¼Œç”œç‚¹å¸ˆå‘Šè¯‰æˆ‘å·²ç»æ²¡æœ‰ä¸”ä¸å†åšäº†ï¼Œé‚£æˆ‘åªèƒ½é—æ†¾åœ°å›å®¶äº†ï¼Œåˆæ˜¯å€’éœ‰çš„ä¸€å¤©ã€‚ğŸ°ğŸ˜¢</p>
<p>ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span><br><br>std::mutex mtx; <span class="hljs-comment">// äº’æ–¥é‡</span><br>std::condition_variable cv; <span class="hljs-comment">// æ¡ä»¶å˜é‡</span><br>std::queue&lt;<span class="hljs-type">int</span>&gt; buffer; <span class="hljs-comment">// å…±äº«ç¼“å†²åŒº</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> BUFFER_SIZE = <span class="hljs-number">10</span>; <span class="hljs-comment">// ç¼“å†²åŒºå¤§å°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> PRODUCER_NUM = <span class="hljs-number">2</span>; <span class="hljs-comment">// ç”Ÿäº§è€…ä¸ªæ•°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> CONSUMER_NUM = <span class="hljs-number">5</span>; <span class="hljs-comment">// æ¶ˆè´¹è€…ä¸ªæ•°</span><br><span class="hljs-type">int</span> produce_finished_count; <span class="hljs-comment">// ç”Ÿäº§è€…å®Œæˆè®¡æ•°</span><br><span class="hljs-comment">// std::atomic&lt;int&gt; produce_finished_count; // ä¹Ÿå¯ä»¥ç”¨åŸå­æ“ä½œ</span><br><br><span class="hljs-comment">// ç”Ÿäº§è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> data_num)</span></span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= data_num; i ++ )&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer æœ‰ç©ºé—´å¯æ”¾å…¥æ•°æ®ï¼ˆå¾ªç¯æ£€æŸ¥ï¼Œé˜²æ­¢è™šå‡å”¤é†’ï¼‰</span><br>        <span class="hljs-keyword">while</span>(buffer.<span class="hljs-built_in">size</span>() &gt;= BUFFER_SIZE)&#123;<br>            cv.<span class="hljs-built_in">wait</span>(lck); <span class="hljs-comment">// é»˜è®¤ falseï¼Œè§£é”å¹¶è¿›å…¥ç­‰å¾…</span><br>        &#125;<br>        buffer.<span class="hljs-built_in">push</span>(i);<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;producer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; produced data: &quot;</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>    &#125;<br>    &#123;<br>        <span class="hljs-comment">// å½“å‰ç”Ÿäº§è€…ç”Ÿæˆæ•°æ®å®Œæ¯•ï¼Œä¿®æ”¹å®Œæˆæ•°æ®ç”Ÿæˆçš„ç”Ÿäº§è€…è®°æ•°</span><br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        produce_finished_count ++ ;<br>        <span class="hljs-keyword">if</span>(produce_finished_count == PRODUCER_NUM)&#123; <br>            cv.<span class="hljs-built_in">notify_all</span>(); <span class="hljs-comment">// å”¤é†’ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lck</span><span class="hljs-params">(mtx)</span></span>;<br>        <span class="hljs-comment">// ç­‰å¾… buffer ä¸­æœ‰æ•°æ®å¯æ¶ˆè´¹ï¼ˆå¾ªç¯æ£€æŸ¥ï¼Œé˜²æ­¢è™šå‡å”¤é†’ï¼‰</span><br>        <span class="hljs-keyword">while</span>(buffer.<span class="hljs-built_in">empty</span>() &amp;&amp; produce_finished_count &lt; PRODUCER_NUM)&#123;<br>            cv.<span class="hljs-built_in">wait</span>(lck); <span class="hljs-comment">// é»˜è®¤ falseï¼Œè§£é”å¹¶è¿›å…¥ç­‰å¾…</span><br>        &#125;<br>        <span class="hljs-comment">// ä¸Šé¢çš„æ£€æŸ¥ä¸­ï¼Œå¯èƒ½å› ä¸º produce_finished_count == PRODUCER_NUM è€Œé€€å‡º</span><br>        <span class="hljs-comment">// buffer å¯èƒ½ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰æ–°çš„æ•°æ®å†ç”Ÿäº§ï¼Œè¿™ä¸ªæ—¶å€™ä» while(true) é€€å‡º</span><br>        <span class="hljs-comment">// buffer ä¹Ÿå¯èƒ½è¿˜æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…ç»§ç»­æ‰§è¡Œä¸‹å»æ¶ˆè´¹æ•°æ®ã€‚</span><br>        <span class="hljs-keyword">if</span>(buffer.<span class="hljs-built_in">empty</span>() &amp;&amp; produce_finished_count == PRODUCER_NUM)&#123;<br>            <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// é€€å‡º</span><br>        &#125;<br>        <span class="hljs-type">int</span> data = buffer.<span class="hljs-built_in">front</span>();<br>        buffer.<span class="hljs-built_in">pop</span>();<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;consumer &quot;</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">&quot; consumed data: &quot;</span> &lt;&lt; data &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>        lck.<span class="hljs-built_in">unlock</span>();     <span class="hljs-comment">// æå‰è§£é”</span><br>        cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// å”¤é†’ç­‰å¾…çŠ¶æ€çš„ç”Ÿäº§è€…çº¿ç¨‹</span><br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä¸ cv æ— å…³çš„ã€æ— éœ€äº’æ–¥é‡çš„æ•°æ®æ“ä½œï¼Œæ”¾åœ¨è§£é”å’Œå”¤é†’ä¹‹å</span><br>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">producers</span><span class="hljs-params">(PRODUCER_NUM)</span></span>;<br>    <span class="hljs-function">std::vector&lt;std::thread&gt; <span class="hljs-title">consumers</span><span class="hljs-params">(CONSUMER_NUM)</span></span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; producers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        producers[i] = std::<span class="hljs-built_in">thread</span>(producer, i + <span class="hljs-number">1</span>, <span class="hljs-number">100</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; consumers.<span class="hljs-built_in">size</span>(); i ++ )&#123;<br>        consumers[i] = std::<span class="hljs-built_in">thread</span>(consumer, i + <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : producers) t.<span class="hljs-built_in">join</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; t : consumers) t.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¯èƒ½çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://sukicdn.com/wyx/i/2025/01/01/11usl.png" srcset="https://sukicdn.com/wyx/i/2025/01/10/dlz.gif" lazyload alt=""></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é¡ºåˆ©çš„æ‰§è¡Œï¼Œå¹¶ä¸”æœ€åæ•°æ®å…¨éƒ¨æ¶ˆè´¹å®Œåç¨‹åºæ­£å¸¸åœ°é€€å‡ºäº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå°å°çš„å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å°±æ˜¯ï¼Œå¯¹å®Œæˆç”Ÿäº§å·¥ä½œçš„ç”Ÿäº§è€…è®¡æ•° <code>produce_finished_count</code> çš„äº’æ–¥è®¿é—®å’Œä¿®æ”¹åªæœ‰ç®€å•çš„è‡ªåŠ æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ <code>std::atomic</code> åŸå­æ“ä½œæ¥å®ç°å¯¹ <code>produce_finished_count</code> äº’æ–¥ï¼Œä½¿å¾—ç¨‹åºæ›´åŠ é«˜æ•ˆã€‚ä¸è¿‡ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å†™åˆ°æœ‰å…³ <strong>åŸå­æ“ä½œ</strong> çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æš‚æ—¶ä¸å±•å¼€äº†ã€‚ğŸ˜‰</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ol>
<li>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/condition_variable/wait">std::condition_variable::wait</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/condition_variable/notify_one">std::condition_variable::notify_one</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/condition_variable/notify_all">std::condition_variable::notify_all</a></p>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%BF%BD%E9%80%90%E7%B9%81%E6%98%9F/" class="category-chain-item">è¿½é€ç¹æ˜Ÿ</a>
  
  
    <span>></span>
    
  <a href="/categories/%E8%BF%BD%E9%80%90%E7%B9%81%E6%98%9F/C-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0/" class="category-chain-item">C++ å¤šçº¿ç¨‹å­¦ä¹ </a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/C/" class="print-no-link">#C++</a>
      
        <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="print-no-link">#å¤šçº¿ç¨‹</a>
      
        <a href="/tags/std-thread/" class="print-no-link">#std::thread</a>
      
        <a href="/tags/std-mutex/" class="print-no-link">#std::mutex</a>
      
        <a href="/tags/std-condition-variable/" class="print-no-link">#std::condition_variable</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€ŒC++ å¤šçº¿ç¨‹ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜åŠ std::condition_variable</div>
      <div>https://marisamagic.github.io/2025/01/01/20250101/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>MarisaMagic</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2025å¹´1æœˆ1æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/01/02/20250102/" title="ã€ŒC++ å¤šçº¿ç¨‹ã€std::async å¼‚æ­¥ä»»åŠ¡åˆ›å»º">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€ŒC++ å¤šçº¿ç¨‹ã€std::async å¼‚æ­¥ä»»åŠ¡åˆ›å»º</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/30/20241230/" title="ã€ŒC++ å¤šçº¿ç¨‹ã€std::call_once, std::once_flag">
                        <span class="hidden-mobile">ã€ŒC++ å¤šçº¿ç¨‹ã€std::call_once, std::once_flag</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div style="font-size: 1rem"> <span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span> <script src="/js/duration.js"></script> </div> Blog by MarisaMagic <br/> Made with  <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/scrollAnimation.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
